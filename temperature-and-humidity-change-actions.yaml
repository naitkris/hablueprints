blueprint:
  name: Temperature and Humidity Change Actions
  description: >
    # ↕️ Temperature and Humidity Change Actions

    **Version: 1.0**

    Monitors all temperature and humidity sensors and triggers an action when
    any of them changes (increases or decreases) by a significant amount within
    a configurable time period in minutes (amount changed and minutes are both
    configurable). This is useful for detecting sudden environmental changes,
    device malfunctions, when the temperature and/or humidity changes due to
    opened doors/windows, to act as a heat alarm, etc.

    You can also choose any temperature or humidity sensors that should be ignored
    by this automation.
  domain: automation

  input:
    monitor_temperature:
      name: Monitor temperature sensors
      default: true
      selector:
        boolean:

    monitor_humidity:
      name: Monitor humidity sensors
      default: true
      selector:
        boolean:

    lookback_minutes:
      name: Lookback (minutes)
      default: 5
      selector:
        number:
          min: 1
          max: 240
          unit_of_measurement: minutes

    temp_threshold:
      name: Temperature threshold (°C)
      default: 2.0
      selector:
        number:
          min: 0.1
          max: 20
          step: 0.1
          unit_of_measurement: °C

    humidity_threshold:
      name: Humidity threshold (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          step: 1
          unit_of_measurement: "%"

    ignore_entities:
      name: Ignore sensors
      default: []
      selector:
        entity:
          multiple: true

    notification_target:
      name: Notification Target
      description: The notify service to send alerts to.
      selector:
        target:

mode: queued
max_exceeded: silent

trigger:
  - platform: time_pattern
    minutes: "/1"

action:
  - variables:
      now_ts: "{{ as_timestamp(now()) }}"
      changes: []

  # Loop through all sensors
  - repeat:
      for_each: >
        {{ states.sensor
          | selectattr('state','is_number')
          | rejectattr('entity_id','in', ignore_entities)
          | list }}
      sequence:
        - variables:
            entity: "{{ repeat.item.entity_id }}"
            name: "{{ repeat.item.name }}"
            current: "{{ repeat.item.state | float(0) }}"
            device_class: "{{ repeat.item.attributes.device_class | default('') }}"
            is_temp: "{{ monitor_temperature and (device_class=='temperature' or 'temperature' in entity) }}"
            is_hum: "{{ monitor_humidity and (device_class=='humidity' or 'humidity' in entity) }}"

        - condition: template
          value_template: "{{ (is_temp or is_hum) and repeat.item.state not in ['unknown','unavailable'] }}"

        # Pre-created helpers
        - variables:
            num_helper: "input_number.prev_{{ entity|replace('.', '_') }}"
            time_helper: "input_datetime.prev_{{ entity|replace('.', '_') }}_time"

        - variables:
            prev_val: "{{ states(num_helper) | float(0) }}"
            prev_time: "{{ as_timestamp(states(time_helper)) if states(time_helper) not in ['unknown','unavailable',None] else 0 }}"
            minutes_since: "{{ (now_ts - prev_time)/60 if prev_time>0 else lookback_minutes + 1 }}"
            diff: "{{ current - prev_val }}"

        - choose:
            - conditions: >
                {{ minutes_since >= lookback_minutes and
                  ((is_temp and (diff|abs >= temp_threshold)) or
                   (is_hum and (diff|abs >= humidity_threshold))) }}
              sequence:
                - variables:
                    msg: "⚠️ {{ name }} changed by {{ diff | round(1) }}{{ '°C' if is_temp else '%' }} in last {{ minutes_since | int }} minutes"
                - variables:
                    changes: "{{ changes + [msg] }}"

        # Update helpers
        - service: input_number.set_value
          data:
            entity_id: "{{ num_helper }}"
            value: "{{ current }}"
        - service: input_datetime.set_datetime
          data:
            entity_id: "{{ time_helper }}"
            timestamp: "{{ now_ts }}"

  # Send notification if any changes detected
  - choose:
      - conditions: "{{ changes | count > 0 }}"
        sequence:
          - service: notify.mobile_app_yourdevice
            data:
              message: >
                Significant temperature/humidity changes detected:
                {{ '\n'.join(changes) }}
