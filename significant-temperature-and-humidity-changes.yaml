blueprint:
  name: Significant Temperature and Humidity Changes
  description: >
    # ↕️ Significant Temperature and Humidity Changes

    **Version: 1.0**

    Monitors all temperature and humidity sensors and triggers an alert when any
    of them changes significantly (increase or decrease) within a configurable
    time period. Useful for detecting sudden environmental changes, device
    malfunctions, open doors/windows, or to act as a heat alarm.

    You can also choose any temperature or humidity sensors that should be ignored
    by this automation.
  domain: automation
  input:
    monitored_types:
      name: Sensor types to monitor
      description: Select whether to monitor temperature, humidity, or both.
      default: ["temperature", "humidity"]
      selector:
        select:
          options:
            - temperature
            - humidity
          multiple: true

    change_direction:
      name: Change direction
      description: >
        Whether to alert for increases, decreases, or both.
      default: both
      selector:
        select:
          options:
            - increase
            - decrease
            - both

    temp_threshold:
      name: Temperature change threshold (°C)
      description: >
        The amount of temperature change required to trigger an alert.
      default: 2
      selector:
        number:
          min: 0.1
          max: 20
          step: 0.1
          unit_of_measurement: °C

    humidity_threshold:
      name: Humidity change threshold (%)
      description: >
        The amount of humidity change required to trigger an alert.
      default: 5
      selector:
        number:
          min: 1
          max: 40
          step: 1
          unit_of_measurement: "%"

    time_window:
      name: Time window (minutes)
      description: >
        How far back to look when comparing readings.
      default: 2
      selector:
        number:
          min: 1
          max: 120
          step: 1
          unit_of_measurement: minutes

    cooldown:
      name: Minimum time between alerts (minutes)
      description: >
        Prevents repeated alerts for the same sensor in a short time.
      default: 30
      selector:
        number:
          min: 1
          max: 360
          step: 1
          unit_of_measurement: minutes

    ignore_entities:
      name: Sensors to ignore
      description: >
        Choose any temperature or humidity sensors that should be ignored by this automation.
      default: []
      selector:
        entity:
          domain: sensor
          multiple: true

    notify_action:
      name: Action to perform when triggered
      description: >
        What to do when a significant change is detected (send a notification, play a sound, etc.).
      default: []
      selector:
        action: {}

mode: restart
max_exceeded: silent

trigger:
  - platform: state
    entity_id: []
    domain: sensor
    device_class: temperature
  - platform: state
    entity_id: []
    domain: sensor
    device_class: humidity

variables:
  monitored_types: !input monitored_types
  change_direction: !input change_direction
  temp_threshold: !input temp_threshold
  humidity_threshold: !input humidity_threshold
  time_window: !input time_window
  cooldown: !input cooldown
  ignore_entities: !input ignore_entities

condition:
  # Ignore sensors listed in ignore_entities
  - condition: template
    value_template: "{{ trigger.entity_id not in ignore_entities }}"
  # Only continue for the monitored sensor types
  - condition: template
    value_template: >
      {% set cls = state_attr(trigger.entity_id, 'device_class') %}
      {{ cls in monitored_types }}

action:
  - variables:
      entity_id: "{{ trigger.entity_id }}"
      device_class: "{{ state_attr(entity_id, 'device_class') }}"
      now_val: "{{ states(entity_id) | float(0) }}"
      old_val: "{{ trigger.from_state.state | float(0) }}"
      diff: "{{ now_val - old_val }}"
      abs_diff: "{{ (now_val - old_val) | abs }}"
      threshold: >
        {% if device_class == 'temperature' %}
          {{ temp_threshold }}
