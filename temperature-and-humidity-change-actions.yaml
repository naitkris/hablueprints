blueprint:
  name: Temperature and Humidity Change Actions
  description: >
    # ↕️ Temperature and Humidity Change Actions

    **Version: 1.0**

    Monitors all temperature and humidity sensors and triggers an action when
    any of them changes (increases or decreases) by a significant amount within
    a configurable time period in minutes (amount changed and minutes are both
    configurable). This is useful for detecting sudden environmental changes,
    device malfunctions, when the temperature and/or humidity changes due to
    opened doors/windows, to act as a heat alarm, etc.

    You can also choose any temperature or humidity sensors that should be ignored
    by this automation.
  domain: automation

  input:
    monitor_temperature:
      name: Monitor temperature sensors
      default: true
      selector:
        boolean:

    monitor_humidity:
      name: Monitor humidity sensors
      default: true
      selector:
        boolean:

    lookback_minutes:
      name: Lookback (minutes)
      default: 5
      selector:
        number:
          min: 1
          max: 240
          unit_of_measurement: minutes

    temp_threshold:
      name: Temperature threshold (°C)
      default: 2.0
      selector:
        number:
          min: 0.1
          max: 20
          step: 0.1
          unit_of_measurement: °C

    humidity_threshold:
      name: Humidity threshold (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          step: 1
          unit_of_measurement: "%"

    ignore_entities:
      name: Ignore sensors
      default: []
      selector:
        entity:
          multiple: true

    notify_actions:
      name: Notification actions
      description: Select one or more notification actions to send alerts.
      default: []
      selector:
        action: {}

    language:
      name: Language
      default: en
      selector:
        select:
          options:
            - label: English
              value: en
            - label: Swedish
              value: sv
            - label: Polish
              value: pl

mode: queued
max_exceeded: silent

trigger:
  - platform: time_pattern
    minutes: "/1"

action:
  - variables:
      now_ts: "{{ as_timestamp(now()) }}"
      changes: []

  - repeat:
      for_each: >
        {{ states.sensor
          | selectattr('state','is_number')
          | rejectattr('entity_id','in', ignore_entities)
          | list }}
      sequence:
        - variables:
            entity: "{{ repeat.item.entity_id }}"
            name: "{{ repeat.item.name }}"
            current: "{{ repeat.item.state | float(0) }}"
            device_class: "{{ repeat.item.attributes.device_class | default('') }}"
            is_temp: "{{ monitor_temperature and (device_class=='temperature' or 'temperature' in entity) }}"
            is_hum: "{{ monitor_humidity and (device_class=='humidity' or 'humidity' in entity) }}"

        - condition: template
          value_template: "{{ (is_temp or is_hum) and repeat.item.state not in ['unknown','unavailable'] }}"

        # Define helpers
        - variables:
            num_helper: "input_number.prev_{{ entity|replace('.', '_') }}"
            time_helper: "input_datetime.prev_{{ entity|replace('.', '_') }}_time"

        # Create helpers if they do not exist
        - choose:
            - conditions: "{{ num_helper not in states }}"
              sequence:
                - service: input_number.set_value
                  data:
                    entity_id: "{{ num_helper }}"
                    value: "{{ current }}"
            - conditions: "{{ time_helper not in states }}"
              sequence:
                - service: input_datetime.set_datetime
                  data:
                    entity_id: "{{ time_helper }}"
                    timestamp: "{{ now_ts }}"

        # Compute previous value, time, diff
        - variables:
            prev_val: "{{ states(num_helper) | float(0) }}"
            prev_time: "{{ as_timestamp(states(time_helper)) if states(time_helper) not in ['unknown','unavailable',None] else 0 }}"
            minutes_since: "{{ (now_ts - prev_time)/60 if prev_time > 0 else lookback_minutes + 1 }}"
            diff: "{{ current - prev_val }}"

        # Check if threshold exceeded
        - choose:
            - conditions: >
                {{ minutes_since >= lookback_minutes and
                  ((is_temp and (diff|abs >= temp_threshold)) or
                   (is_hum and (diff|abs >= humidity_threshold))) }}
              sequence:
                - variables:
                    msg_en: "⚠️ {{ name }} changed by {{ diff|round(1) }}{{ '°C' if is_temp else '%' }} in last {{ minutes_since|int }} minutes"
                    msg_sv: "⚠️ {{ name }} ändrades med {{ diff|round(1) }}{{ '°C' if is_temp else '%' }} under de senaste {{ minutes_since|int }} minuterna"
                    msg_pl: "⚠️ {{ name }} zmienił się o {{ diff|round(1) }}{{ '°C' if is_temp else '%' }} w ciągu {{ minutes_since|int }} minut"
                    msg: >
                      {% if language == 'sv' %}
                        {{ msg_sv }}
                      {% elif language == 'pl' %}
                        {{ msg_pl }}
                      {% else %}
                        {{ msg_en }}
                      {% endif %}
                - variables:
                    changes: "{{ changes + [msg] }}"

        # Update helpers
        - service: input_number.set_value
          data:
            entity_id: "{{ num_helper }}"
            value: "{{ current }}"
        - service: input_datetime.set_datetime
          data:
            entity_id: "{{ time_helper }}"
            timestamp: "{{ now_ts }}"

  # Send notifications
  - choose:
      - conditions: "{{ changes | count > 0 }}"
        sequence:
          - variables:
              message: "{{ '\n'.join(changes) }}"
          - repeat:
              for_each: !input notify_actions
              sequence:
                - service: "{{ repeat.item.service }}"
                  data: >-
                    {% if repeat.item.data is defined %}
                      {{ repeat.item.data | combine({'message': message}) }}
                    {% else %}
                      {'message': message}
                    {% endif %}
